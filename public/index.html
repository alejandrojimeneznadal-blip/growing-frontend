<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growing Inmobiliario - Centro de Soporte</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #34BCFF;
            --dark-blue: #166A88;
            --bright-cyan: #41F2F9;
            --light-gray: #E8F6FA;
            --light-blue-bg: rgba(52, 188, 255, 0.08);
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --border-color: rgba(52, 188, 255, 0.15);
            --white: #FFFFFF;
            --sidebar-width: 320px;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F9FEFF;
            --shadow-sm: 0 2px 4px rgba(22, 106, 136, 0.05);
            --shadow-md: 0 4px 12px rgba(22, 106, 136, 0.08);
            --shadow-lg: 0 8px 24px rgba(22, 106, 136, 0.12);
        }

        body.dark-mode {
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --border-color: rgba(52, 188, 255, 0.2);
            --white: #111827;
            --light-gray: #1F2937;
            --light-blue-bg: rgba(52, 188, 255, 0.1);
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .icon {
            width: 20px; height: 20px;
            stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round;
            fill: none;
        }

        /* Splash Screen */
        .splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .splash-screen.active { opacity: 1; pointer-events: all; }
        .splash-logo { font-size: 4rem; font-weight: 700; color: white; margin-bottom: 2rem; }
        .splash-loader {
            width: 60px; height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .splash-text { color: white; font-size: 1.125rem; margin-top: 2rem; opacity: 0; animation: fadeIn 1s ease 0.5s forwards; }

        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Auth Styles */
        .auth-container { display: flex; height: 100vh; background: var(--bg-primary); }
        .auth-sidebar {
            width: 40%;
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
            display: flex; align-items: center; justify-content: center;
            padding: 2rem; color: white;
        }
        .auth-content {
            width: 60%; display: flex; align-items: center; justify-content: center;
            padding: 2rem; background: var(--bg-primary);
        }
        .auth-form-container { width: 100%; max-width: 400px; }
        .auth-logo { font-size: 2.5rem; font-weight: 700; color: var(--primary-blue); margin-bottom: 0.5rem; }
        .auth-title { font-size: 1.875rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .auth-subtitle { color: var(--text-secondary); margin-bottom: 2rem; }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-input {
            width: 100%; padding: 0.75rem 1rem;
            border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 0.875rem; transition: all 0.2s;
            background-color: var(--bg-secondary); color: var(--text-primary);
        }
        .form-input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(52, 188, 255, 0.1); }
        .form-input.error { border-color: var(--error); }

        .btn-primary {
            width: 100%; padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--bright-cyan) 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 0.875rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .btn-danger {
            background: var(--error);
            color: white; border: none; border-radius: 8px;
            padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-danger:hover { opacity: 0.9; }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 0.75rem 1.5rem; font-size: 0.875rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-secondary:hover { background: var(--light-blue-bg); }

        .auth-toggle { text-align: center; margin-top: 1.5rem; color: var(--text-secondary); font-size: 0.875rem; }
        .auth-toggle a { color: var(--primary-blue); text-decoration: none; font-weight: 600; cursor: pointer; }

        .error-message { 
            color: var(--error); 
            font-size: 0.875rem; 
            margin: 1rem 0; 
            padding: 0.75rem 1rem;
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            display: none;
        }
        .error-message.show { display: block; }

        .success-message {
            color: var(--success);
            font-size: 0.875rem;
            margin: 1rem 0;
            padding: 0.75rem 1rem;
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            display: none;
        }
        .success-message.show { display: block; }

        /* App Container */
        .app-container { display: none; height: 100vh; background-color: var(--bg-primary); }
        .app-container.active { display: flex; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; height: 100vh;
        }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); background-color: var(--bg-primary); }
        .sidebar-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; }
        .sidebar-subtitle { font-size: 0.75rem; color: var(--text-secondary); }

        .new-chat-btn {
            margin: 1rem; padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--bright-cyan) 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 0.875rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: all 0.2s;
        }
        .new-chat-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }

        .chat-history { flex: 1; overflow-y: auto; padding: 0.5rem; }
        
        .chat-history-item {
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border-radius: 8px; cursor: pointer;
            transition: all 0.2s; border: 1px solid transparent;
        }
        .chat-history-item:hover { background-color: var(--light-blue-bg); }
        .chat-history-item.active { background-color: var(--light-blue-bg); border-color: var(--primary-blue); }
        .chat-history-item.new-chat { border: 1px dashed var(--primary-blue); }
        .chat-history-title { font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-history-preview { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-history-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem; }
        .chat-history-date { font-size: 0.625rem; color: var(--text-secondary); }
        .chat-history-category { font-size: 0.625rem; padding: 0.125rem 0.5rem; background-color: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--primary-blue); border-radius: 4px; }
        
        .chat-history-empty { padding: 2rem 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem; }

        .settings-bar {
            padding: 1rem; background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 0.75rem;
            cursor: pointer; transition: background-color 0.2s;
        }
        .settings-bar:hover { background-color: var(--light-blue-bg); }
        .settings-bar-icon {
            width: 36px; height: 36px; background: rgba(255, 255, 255, 0.9);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            color: var(--dark-blue);
        }
        .settings-bar-text { flex: 1; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; }

        .main-header {
            height: 70px; padding: 1rem 2rem; background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .header-user { display: flex; align-items: center; gap: 0.75rem; }
        .header-avatar {
            width: 48px; height: 48px;
            background: var(--bg-secondary);
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }
        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .header-name { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); }
        .header-status { font-size: 0.75rem; color: var(--success); display: flex; align-items: center; gap: 0.25rem; }
        .status-dot { width: 6px; height: 6px; background-color: var(--success); border-radius: 50%; }

        .header-actions { display: flex; align-items: center; gap: 0.75rem; }
        .header-btn {
            width: 36px; height: 36px; background-color: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--text-secondary);
        }
        .header-btn:hover { background-color: var(--light-blue-bg); color: var(--primary-blue); border-color: var(--primary-blue); }

        /* Dropdown Menu */
        .dropdown-container { position: relative; }
        .dropdown-menu {
            display: none; position: absolute; top: 100%; right: 0;
            background-color: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 8px; min-width: 200px; z-index: 100;
            box-shadow: var(--shadow-lg); margin-top: 0.5rem;
        }
        .dropdown-menu.active { display: block; }
        .dropdown-item {
            padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
            font-size: 0.875rem; color: var(--text-primary); transition: background-color 0.2s;
        }
        .dropdown-item:hover { background-color: var(--light-blue-bg); }
        .dropdown-item:first-child { border-radius: 8px 8px 0 0; }
        .dropdown-item:last-child { border-radius: 0 0 8px 8px; }
        .dropdown-item.danger { color: var(--error); }
        .dropdown-item.danger:hover { background-color: rgba(239, 68, 68, 0.1); }
        .dropdown-divider { height: 1px; background-color: var(--border-color); margin: 0.25rem 0; }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); overflow: hidden; min-height: 0; }

        .welcome-section {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 2rem;
        }
        .welcome-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .welcome-subtitle { color: var(--text-secondary); text-align: center; margin-bottom: 3rem; max-width: 500px; }

        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 900px; width: 100%; }
        .category-card {
            background-color: var(--bg-primary); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 2rem; cursor: pointer;
            transition: all 0.3s; text-align: center;
        }
        .category-card:hover { border-color: var(--primary-blue); box-shadow: var(--shadow-lg); transform: translateY(-2px); background-color: var(--light-blue-bg); }
        .category-card.selected {
            border-color: var(--primary-blue);
            background-color: var(--light-blue-bg);
            transform: scale(1.02);
        }
        .category-icon {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--bright-cyan) 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1rem; color: white;
        }
        .category-icon svg { width: 30px; height: 30px; }
        .category-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
        .category-description { font-size: 0.75rem; color: var(--text-secondary); }

        /* Slide up animation */
        .welcome-section.slide-up {
            animation: slideUpOut 0.4s ease-in-out forwards;
        }
        
        @keyframes slideUpOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        .messages-area.slide-up-in {
            animation: slideUpIn 0.4s ease-out forwards;
        }

        @keyframes slideUpIn {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Messages - Nuevo diseño limpio estilo Claude */
        .messages-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 2rem; 
            display: none;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .messages-area.active { display: block; }

        .message { 
            margin-bottom: 2rem;
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message-content {
            max-width: 85%;
        }

        .message.user .message-content {
            background-color: #F3F4F6;
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
        }

        .message.bot .message-content {
            background: transparent;
            padding: 0;
        }

        .message-text { 
            font-size: 0.9375rem; 
            line-height: 1.7; 
            white-space: pre-line; 
        }

        .message.bot .message-text {
            color: var(--text-primary);
        }

        .message-time { 
            font-size: 0.6875rem; 
            color: var(--text-secondary); 
            margin-top: 0.5rem;
        }
        
        .message.user .message-time { 
            color: var(--text-secondary);
            text-align: right;
        }

        body.dark-mode .message.user .message-content {
            background-color: #374151;
        }

        .message.bot .message-time {
            margin-left: 0;
        }

        .message-image { 
            max-width: 100%; 
            max-height: 300px; 
            border-radius: 12px; 
            margin-bottom: 0.5rem; 
        }
        
        .message.user .message-image {
            border-radius: 12px;
        }

        .message-image-indicator { 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            font-style: italic; 
        }

        /* Input Area */
        .input-area { padding: 1.5rem 2rem; background-color: var(--bg-primary); border-top: 1px solid var(--border-color); }
        .input-container { 
            display: flex; 
            gap: 0.75rem; 
            align-items: center;
            max-width: 900px;
            margin: 0 auto;
        }
        .input-wrapper { flex: 1; position: relative; }
        .message-input {
            width: 100%; padding: 0.875rem 3rem 0.875rem 1rem;
            border: 1px solid var(--border-color); border-radius: 12px;
            font-size: 0.875rem; background-color: var(--bg-secondary);
            color: var(--text-primary); resize: none; outline: none;
            transition: all 0.2s;
        }
        .message-input:focus { background-color: var(--bg-primary); border-color: var(--primary-blue); }
        .message-input:disabled { opacity: 0.6; cursor: not-allowed; }
        .send-btn {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--bright-cyan) 100%);
            border: none; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: white; transition: all 0.2s;
        }
        .send-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
        .send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .attach-btn {
            width: 44px; height: 44px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 12px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); transition: all 0.2s;
        }
        .attach-btn:hover { background-color: var(--light-blue-bg); color: var(--primary-blue); border-color: var(--primary-blue); }
        .attach-btn.has-image { background-color: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        .image-preview-container {
            display: none; padding: 0.75rem 2rem; background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        .image-preview-container.active { display: block; }
        .image-preview-wrapper {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.5rem; background-color: var(--bg-primary);
            border: 1px solid var(--border-color); border-radius: 8px;
            max-width: 300px;
        }
        .image-preview-img {
            width: 60px; height: 60px; object-fit: cover; border-radius: 4px;
        }
        .image-preview-info { flex: 1; min-width: 0; }
        .image-preview-name {
            font-size: 0.75rem; font-weight: 500; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .image-preview-size { font-size: 0.625rem; color: var(--text-secondary); }
        .image-preview-remove {
            width: 24px; height: 24px; background-color: var(--error);
            border: none; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: white; transition: opacity 0.2s;
        }
        .image-preview-remove:hover { opacity: 0.8; }

        /* Modal Base */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: var(--bg-primary); border-radius: 16px;
            width: 90%; max-width: 400px;
            border: 1px solid var(--border-color);
        }
        .modal-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }
        .modal-close {
            width: 32px; height: 32px; background-color: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--text-primary);
        }
        .modal-close:hover { background-color: var(--error); color: white; border-color: var(--error); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.75rem; justify-content: flex-end; }

        /* Settings Modal */
        .settings-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .settings-modal.active { display: flex; }
        .settings-content {
            background-color: var(--bg-primary); border-radius: 16px;
            width: 90%; max-width: 500px; max-height: 80vh;
            overflow-y: auto; border: 1px solid var(--border-color);
        }
        .settings-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        .settings-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .settings-close {
            width: 32px; height: 32px; background-color: var(--bg-secondary);
            border: 1px solid var(--border-color); border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--text-primary);
        }
        .settings-close:hover { background-color: var(--error); color: white; border-color: var(--error); }
        .settings-body { padding: 1.5rem; }
        .settings-section { margin-bottom: 2rem; }
        .settings-section-title { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; }

        .toggle-switch {
            position: relative; width: 48px; height: 24px;
            background-color: var(--border-color); border-radius: 12px;
            cursor: pointer; transition: background-color 0.3s;
        }
        .toggle-switch.active { background-color: var(--primary-blue); }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background-color: white;
            border-radius: 50%; transition: transform 0.3s;
        }
        .toggle-switch.active::after { transform: translateX(24px); }

        .settings-option { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; }
        .settings-option-label { font-size: 0.875rem; color: var(--text-primary); }

        /* Mobile */
        .mobile-menu-btn {
            display: none; position: fixed; top: 1rem; left: 1rem;
            z-index: 100000; width: 40px; height: 40px;
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; align-items: center; justify-content: center;
            cursor: pointer; flex-direction: column; gap: 4px; padding: 8px;
        }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: var(--text-primary); border-radius: 2px; }
        .mobile-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 998; opacity: 0;
            transition: opacity 0.3s; pointer-events: none;
        }
        .mobile-overlay.active { display: block; opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .auth-sidebar { display: none; }
            .auth-content { width: 100%; }
            .sidebar { position: fixed; left: -280px; z-index: 999; transition: left 0.3s ease; }
            .sidebar.active { left: 0; }
            .mobile-menu-btn { display: flex; }
            .category-grid { grid-template-columns: 1fr; }
            .messages-area { padding: 1rem; }
            .message-content { max-width: 90%; }
        }

        .hidden { display: none !important; }

        /* Typing indicator actualizado */
        .typing-indicator { 
            display: flex; 
            gap: 0.35rem; 
            padding: 0.5rem 0;
            align-items: center;
        }
        .typing-dot { 
            width: 8px; 
            height: 8px; 
            background-color: var(--primary-blue); 
            border-radius: 50%; 
            animation: typing 1.4s infinite; 
            opacity: 0.7;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-8px); opacity: 1; } }

        /* Feedback Component */
        .loom-feedback {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            animation: messageAppear 0.3s ease-out;
        }

        .feedback-question {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            opacity: 0;
            transform: translateY(10px);
            animation: feedbackAppear 0.3s ease-out forwards;
        }

        @keyframes feedbackAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-question-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .feedback-thumbs {
            display: flex;
            gap: 0.75rem;
        }

        .feedback-thumb {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .feedback-thumb:hover {
            border-color: var(--primary-blue);
            transform: scale(1.1);
        }

        .feedback-thumb.selected {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .feedback-thumb.selected.positive {
            background: var(--success);
            border-color: var(--success);
        }

        .feedback-thumb.selected.negative {
            background: var(--error);
            border-color: var(--error);
        }

        .feedback-stars {
            display: flex;
            gap: 0.25rem;
        }

        .feedback-star {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--border-color);
            transition: all 0.15s;
        }

        .feedback-star:hover,
        .feedback-star.active {
            color: #FBBF24;
            transform: scale(1.15);
        }

        .feedback-star.active {
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        .feedback-yesno {
            display: flex;
            gap: 0.5rem;
        }

        .feedback-yesno-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-yesno-btn:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue-bg);
        }

        .feedback-yesno-btn.selected {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        .feedback-thanks {
            text-align: center;
            padding: 0.75rem;
            color: var(--success);
            font-weight: 500;
            font-size: 0.875rem;
        }

        /* Escalation Panel */
        .escalation-panel {
            margin-top: 1rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            animation: messageAppear 0.3s ease-out;
        }

        .escalation-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .escalation-subtitle {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .escalation-loom {
            margin-bottom: 1rem;
            border-radius: 8px;
            overflow: hidden;
        }

        .escalation-doc-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--primary-blue);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .escalation-doc-link:hover {
            background: var(--light-blue-bg);
            border-color: var(--primary-blue);
        }

        .escalation-continue-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--primary-blue);
            border-radius: 8px;
            color: var(--primary-blue);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .escalation-continue-btn:hover {
            background: var(--primary-blue);
            color: white;
        }

        /* Category selector for escalation */
        .escalation-category-selector {
            margin-bottom: 1rem;
        }

        .escalation-category-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .escalation-categories {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .escalation-category-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .escalation-category-btn:hover {
            border-color: var(--primary-blue);
        }

        .escalation-category-btn.selected {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }

        /* Chat blocked state */
        .input-area.blocked {
            opacity: 0.5;
            pointer-events: none;
        }

        .input-area.blocked::after {
            content: 'Chat delegado al equipo';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .input-area {
            position: relative;
        }

        /* Delegated category badge */
        .chat-history-category.delegado {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
            color: var(--error);
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">Growing</div>
        <div class="splash-loader"></div>
        <div class="splash-text">Preparando tu experiencia...</div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span></span><span></span><span></span>
    </button>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Login/Register Container -->
    <div class="auth-container" id="authContainer">
        <div class="auth-sidebar">
            <div>
                <h1 style="font-size: 3rem; font-weight: 700; margin-bottom: 1rem;">Growing Inmobiliario</h1>
                <p style="font-size: 1.125rem; opacity: 0.9;">Tu socio estratégico en el mundo inmobiliario</p>
            </div>
        </div>
        <div class="auth-content">
            <div class="auth-form-container">
                <!-- Login Form -->
                <form id="loginForm">
                    <div class="auth-logo">Growing</div>
                    <h2 class="auth-title">Bienvenido de vuelta</h2>
                    <p class="auth-subtitle">Ingresa tus credenciales para continuar</p>
                    
                    <div class="form-group">
                        <label class="form-label">Correo electrónico</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="tu@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="••••••••">
                    </div>

                    <div id="loginError" class="error-message"></div>
                    
                    <button type="submit" class="btn-primary" id="loginBtn">Iniciar Sesión</button>
                    
                    <div class="auth-toggle">
                        ¿No tienes cuenta? <a onclick="toggleAuthForm(event)">Regístrate</a>
                    </div>
                </form>

                <!-- Register Form -->
                <form id="registerForm" class="hidden">
                    <div class="auth-logo">Growing</div>
                    <h2 class="auth-title">Crear cuenta</h2>
                    <p class="auth-subtitle">Únete a la comunidad Growing</p>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre completo</label>
                        <input type="text" class="form-input" id="registerName" required placeholder="Tu nombre">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Correo electrónico</label>
                        <input type="email" class="form-input" id="registerEmail" required placeholder="tu@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-input" id="registerPhone" placeholder="+34 600 000 000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Empresa/Inmobiliaria</label>
                        <input type="text" class="form-input" id="registerCompany" placeholder="Nombre de tu empresa">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña (mínimo 6 caracteres)</label>
                        <input type="password" class="form-input" id="registerPassword" required minlength="6" placeholder="••••••••">
                    </div>

                    <div id="registerError" class="error-message"></div>
                    
                    <button type="submit" class="btn-primary" id="registerBtn">Crear Cuenta</button>
                    
                    <div class="auth-toggle">
                        ¿Ya tienes cuenta? <a onclick="toggleAuthForm(event)">Inicia sesión</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Growing Inmobiliario</div>
                <div class="sidebar-subtitle">Centro de Soporte</div>
            </div>
            
            <button class="new-chat-btn" onclick="startNewChat()">
                <svg class="icon" viewBox="0 0 24 24" stroke="white" fill="none">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                <span>Nuevo Chat</span>
            </button>
            
            <div class="chat-history" id="chatHistory">
                <div class="chat-history-empty">Cargando conversaciones...</div>
            </div>
            
            <div class="settings-bar" onclick="openSettings()">
                <div class="settings-bar-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#166A88" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </div>
                <div class="settings-bar-text">Ajustes</div>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="header-user">
                    <div class="header-avatar">
                        <img src="/images/logo-growing.png" alt="Growing Inmobiliario">
                    </div>
                    <div>
                        <div class="header-name">Asistente de Growing</div>
                        <div class="header-status"><span class="status-dot"></span><span>Disponible</span></div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" title="Buscar">
                        <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                            <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </button>
                    <div class="dropdown-container">
                        <button class="header-btn" id="menuBtn" title="Opciones" onclick="toggleDropdown()">
                            <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                                <circle cx="12" cy="5" r="1" fill="currentColor"/>
                                <circle cx="12" cy="12" r="1" fill="currentColor"/>
                                <circle cx="12" cy="19" r="1" fill="currentColor"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <div class="dropdown-item" onclick="openRenameModal()">
                                <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none" style="width:16px;height:16px;">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Renombrar conversación
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item danger" onclick="confirmDeleteConversation()">
                                <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none" style="width:16px;height:16px;">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                Eliminar conversación
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="chat-area">
                <div class="welcome-section" id="welcomeSection">
                    <h2 class="welcome-title" id="welcomeTitle">¡Bienvenido al Centro de Soporte!</h2>
                    <p class="welcome-subtitle" id="welcomeSubtitle">
                        Estoy aquí para ayudarte a hacer crecer tu inmobiliaria. 
                        Selecciona un tema para comenzar o escribe tu pregunta directamente.
                    </p>
                    
                    <div class="category-grid">
                        <div class="category-card" onclick="selectCategory('comercial')">
                            <div class="category-icon">
                                <svg class="icon" viewBox="0 0 24 24" stroke="white" fill="none">
                                    <rect x="2" y="7" width="20" height="14" rx="2"/>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                                </svg>
                            </div>
                            <h3 class="category-title">Comercial</h3>
                            <p class="category-description">Ventas y captación</p>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('meta-ads')">
                            <div class="category-icon">
                                <svg class="icon" viewBox="0 0 24 24" stroke="white" fill="none">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                </svg>
                            </div>
                            <h3 class="category-title">Meta Ads</h3>
                            <p class="category-description">Publicidad digital</p>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('gohighlevel')">
                            <div class="category-icon">
                                <svg class="icon" viewBox="0 0 24 24" stroke="white" fill="none">
                                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5M12 2L2 7l10 5 10-5-10-5z"/>
                                </svg>
                            </div>
                            <h3 class="category-title">GoHighLevel</h3>
                            <p class="category-description">CRM y automatización</p>
                        </div>
                    </div>
                </div>

                <div class="messages-area" id="messagesArea"></div>

                <div class="image-preview-container" id="imagePreviewContainer">
                    <div class="image-preview-wrapper">
                        <img src="" alt="Preview" class="image-preview-img" id="imagePreviewImg">
                        <div class="image-preview-info">
                            <div class="image-preview-name" id="imagePreviewName">imagen.jpg</div>
                            <div class="image-preview-size" id="imagePreviewSize">0 KB</div>
                        </div>
                        <button class="image-preview-remove" onclick="removeSelectedImage()">
                            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button class="attach-btn" id="attachBtn" onclick="document.getElementById('imageInput').click()" title="Adjuntar imagen">
                            <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </button>
                        <div class="input-wrapper">
                            <input type="text" class="message-input" id="messageInput" 
                                   placeholder="Escribe tu mensaje aquí..." onkeypress="handleKeyPress(event)">
                        </div>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <svg class="icon" viewBox="0 0 24 24" stroke="white" fill="none">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Renombrar conversación</h3>
                <button class="modal-close" onclick="closeRenameModal()">
                    <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Nuevo nombre</label>
                    <input type="text" class="form-input" id="renameInput" placeholder="Nombre de la conversación">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeRenameModal()">Cancelar</button>
                <button class="btn-primary" style="width: auto;" onclick="renameConversation()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Eliminar conversación</h3>
                <button class="modal-close" onclick="closeDeleteModal()">
                    <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary);">¿Estás seguro de que deseas eliminar esta conversación? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn-danger" onclick="deleteConversation()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2 class="settings-title">Ajustes</h2>
                <button class="settings-close" onclick="closeSettings()">
                    <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="settings-body">
                <div class="settings-section">
                    <h3 class="settings-section-title">Mi Cuenta</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Nombre</label>
                            <input type="text" class="form-input" id="settingsName" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Email</label>
                            <input type="email" class="form-input" id="settingsEmail" style="width: 100%;" disabled>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Teléfono</label>
                            <input type="tel" class="form-input" id="settingsPhone" style="width: 100%;" placeholder="+34 600 000 000">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Empresa</label>
                            <input type="text" class="form-input" id="settingsCompany" style="width: 100%;" placeholder="Nombre de tu empresa">
                        </div>
                        <button class="btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="openChangePasswordModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            Cambiar contraseña
                        </button>
                        <button class="btn-primary" style="width: 100%;" onclick="saveProfile()">Guardar cambios</button>
                    </div>
                </div>
                <div class="settings-section">
                    <h3 class="settings-section-title">Preferencias</h3>
                    <div class="settings-option">
                        <span class="settings-option-label">Modo oscuro</span>
                        <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()"></div>
                    </div>
                    <div class="settings-option">
                        <span class="settings-option-label">Notificaciones</span>
                        <div class="toggle-switch" id="notificationsToggle" onclick="toggleNotifications()"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <button class="btn-danger" style="width: 100%;" onclick="logout()">Cerrar Sesión</button>
                </div>
                <div class="settings-section" id="adminSection" style="display: none;">
                    <h3 class="settings-section-title">Administración</h3>
                    <button class="btn-primary" style="width: 100%; background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);" onclick="goToAdmin()">
                        Panel de Administrador
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cambiar contraseña</h3>
                <button class="modal-close" onclick="closeChangePasswordModal()">
                    <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Contraseña actual</label>
                    <input type="password" class="form-input" id="currentPassword">
                </div>
                <div class="form-group">
                    <label class="form-label">Nueva contraseña</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Mínimo 6 caracteres">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Confirmar nueva contraseña</label>
                    <input type="password" class="form-input" id="confirmPassword">
                </div>
                <div id="passwordError" class="error-message"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeChangePasswordModal()">Cancelar</button>
                <button class="btn-primary" style="width: auto;" onclick="changePassword()">Cambiar</button>
            </div>
        </div>
    </div>

    <!-- API Client -->
    <script src="/js/api-client.js"></script>
    
    <script>
        // State
        let currentUser = null;
        let userIsAdmin = false;
        let darkMode = false;
        let currentConversationId = null;
        let currentConversationTitle = '';
        let isSending = false;
        let currentChatHasMessages = false;
        
        // Image state
        let selectedImageBase64 = null;
        let selectedImageMimeType = null;
        let selectedImageName = null;
        
        // Category state (for when no conversation exists yet)
        let selectedCategory = null;
        
        // Store for local conversations (new chats that haven't been synced yet or loaded ones)
        let localConversations = {};

        // Welcome messages variants
        const welcomeMessages = [
            { title: '¡Bienvenido al Centro de Soporte!', subtitle: 'Estoy aquí para ayudarte a hacer crecer tu inmobiliaria. Selecciona un tema para comenzar o escribe tu pregunta directamente.' },
            { title: '¿En qué puedo ayudarte hoy?', subtitle: 'Elige una categoría o escribe tu consulta directamente. Estoy listo para asistirte.' },
            { title: '¡Hola! Comencemos una nueva conversación', subtitle: 'Selecciona el área en la que necesitas ayuda o simplemente escribe tu pregunta.' },
            { title: '¡Nueva consulta!', subtitle: 'Estoy aquí para resolver tus dudas sobre ventas, publicidad o automatización. ¿Por dónde empezamos?' },
            { title: '¿Listo para resolver dudas?', subtitle: 'Escoge un tema de los siguientes o escríbeme directamente lo que necesitas.' },
            { title: '¡Perfecto! Nuevo chat iniciado', subtitle: 'Cuéntame qué necesitas o selecciona una de las categorías para comenzar.' }
        ];

        // Escalation resources by category
        const escalationResources = {
            'comercial': {
                loom: 'https://www.loom.com/embed/7e0f0786cfea4117b2dd3e60c0044a04',
                doc: 'https://docs.google.com/document/d/1fZ1DjC6EJN-6zdHe5Od-GS9GyK20EHno7cngeilnrcQ/edit?tab=t.0#heading=h.69m5fb7p9d1n',
                name: 'Comercial'
            },
            'meta-ads': {
                loom: 'https://www.loom.com/embed/149021af79ca4b5292d9b96c267e46b4',
                doc: 'https://docs.google.com/document/d/1OJc5e9K7Q7wXKbdyaLy-N71OCQRKKyxtSZXa31u1N3s/edit?tab=t.0#heading=h.88m08f4dtq7o',
                name: 'Meta Ads'
            },
            'gohighlevel': {
                loom: 'https://www.loom.com/embed/fdb4e4e0f87741f3850c8c7d6f213bd5',
                doc: 'https://docs.google.com/document/d/1xjeFHci-ZmNDi69Rpm7rjJBBqxbcQurom4m7P_5v2Zo/edit?tab=t.0#heading=h.88m08f4dtq7o',
                name: 'GoHighLevel'
            }
        };

        // Feedback state
        let feedbackCounter = 0;

        // Función para traducir errores del backend a español
        function translateError(error) {
            if (!error) return 'Ha ocurrido un error inesperado';
            
            var errorLower = error.toLowerCase();
            
            // Errores de autenticación
            if (errorLower.includes('invalid credentials') || errorLower.includes('invalid password')) {
                return 'La contraseña es incorrecta';
            }
            if (errorLower.includes('user not found') || errorLower.includes('no user found') || errorLower.includes('email not found')) {
                return 'No existe una cuenta con este correo electrónico';
            }
            if (errorLower.includes('email already') || errorLower.includes('already registered') || errorLower.includes('already exists')) {
                return 'Ya existe una cuenta con este correo electrónico';
            }
            if (errorLower.includes('invalid email')) {
                return 'El formato del correo electrónico no es válido';
            }
            if (errorLower.includes('password') && errorLower.includes('short')) {
                return 'La contraseña debe tener al menos 6 caracteres';
            }
            if (errorLower.includes('unauthorized') || errorLower.includes('not authorized')) {
                return 'No tienes autorización para realizar esta acción';
            }
            if (errorLower.includes('token') && (errorLower.includes('expired') || errorLower.includes('invalid'))) {
                return 'Tu sesión ha expirado. Por favor, inicia sesión de nuevo';
            }
            
            // Errores de conexión
            if (errorLower.includes('network') || errorLower.includes('connection') || errorLower.includes('fetch')) {
                return 'Error de conexión. Comprueba tu conexión a internet';
            }
            if (errorLower.includes('timeout')) {
                return 'El servidor tardó demasiado en responder. Inténtalo de nuevo';
            }
            if (errorLower.includes('server') || errorLower.includes('500')) {
                return 'Error del servidor. Inténtalo de nuevo más tarde';
            }
            
            // Errores de validación
            if (errorLower.includes('required') && errorLower.includes('email')) {
                return 'El correo electrónico es obligatorio';
            }
            if (errorLower.includes('required') && errorLower.includes('password')) {
                return 'La contraseña es obligatoria';
            }
            if (errorLower.includes('required') && errorLower.includes('name')) {
                return 'El nombre es obligatorio';
            }
            if (errorLower.includes('required')) {
                return 'Por favor, completa todos los campos obligatorios';
            }
            
            // Si no coincide con ningún patrón conocido, devolver el error original
            // pero capitalizado y sin prefijos técnicos
            var cleanError = error.replace(/^error:\s*/i, '').replace(/^Error:\s*/i, '');
            return cleanError.charAt(0).toUpperCase() + cleanError.slice(1);
        }

        // ==================== FEEDBACK SYSTEM ====================
        
        // Create feedback component for Loom messages
        function createFeedbackComponent(messageId) {
            feedbackCounter++;
            var feedbackId = 'feedback-' + feedbackCounter;
            
            var container = document.createElement('div');
            container.className = 'loom-feedback';
            container.id = feedbackId;
            container.setAttribute('data-message-id', messageId || '');
            container.setAttribute('data-step', '0');
            
            // Initial question
            var initialQuestion = document.createElement('div');
            initialQuestion.className = 'feedback-question';
            initialQuestion.style.animationDelay = '0.5s';
            initialQuestion.innerHTML = 
                '<span class="feedback-question-text">¿Se ha resuelto tu consulta?</span>' +
                '<div class="feedback-thumbs">' +
                    '<button class="feedback-thumb" onclick="handleFeedbackThumb(\'' + feedbackId + '\', false)" title="No">👎</button>' +
                    '<button class="feedback-thumb" onclick="handleFeedbackThumb(\'' + feedbackId + '\', true)" title="Sí">👍</button>' +
                '</div>';
            
            container.appendChild(initialQuestion);
            return container;
        }
        
        // Handle initial thumb response
        function handleFeedbackThumb(feedbackId, resolved) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var thumbs = container.querySelectorAll('.feedback-thumb');
            thumbs.forEach(function(thumb) {
                thumb.disabled = true;
                thumb.style.cursor = 'default';
            });
            
            if (resolved) {
                // Mark positive thumb as selected
                thumbs[1].classList.add('selected', 'positive');
                container.setAttribute('data-resolved', 'true');
                
                // Save initial feedback
                saveFeedback(feedbackId, { resolved: true });
                
                // Show next question after delay
                setTimeout(function() {
                    showSpeedQuestion(feedbackId);
                }, 300);
            } else {
                // Mark negative thumb as selected
                thumbs[0].classList.add('selected', 'negative');
                container.setAttribute('data-resolved', 'false');
                
                // Save initial feedback
                saveFeedback(feedbackId, { resolved: false });
                
                // Show escalation panel
                setTimeout(function() {
                    showEscalationPanel(feedbackId);
                }, 300);
            }
        }
        
        // Show speed rating question
        function showSpeedQuestion(feedbackId) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var question = document.createElement('div');
            question.className = 'feedback-question';
            question.innerHTML = 
                '<span class="feedback-question-text">Velocidad de respuesta</span>' +
                '<div class="feedback-stars" data-type="speed">' +
                    createStarsHTML(feedbackId, 'speed') +
                '</div>';
            
            container.appendChild(question);
            scrollToBottom();
        }
        
        // Show quality rating question
        function showQualityQuestion(feedbackId) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var question = document.createElement('div');
            question.className = 'feedback-question';
            question.innerHTML = 
                '<span class="feedback-question-text">Calidad de la respuesta</span>' +
                '<div class="feedback-stars" data-type="quality">' +
                    createStarsHTML(feedbackId, 'quality') +
                '</div>';
            
            container.appendChild(question);
            scrollToBottom();
        }
        
        // Show clear steps question
        function showClearStepsQuestion(feedbackId) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var question = document.createElement('div');
            question.className = 'feedback-question';
            question.innerHTML = 
                '<span class="feedback-question-text">¿Pasos claros para resolver?</span>' +
                '<div class="feedback-yesno">' +
                    '<button class="feedback-yesno-btn" onclick="handleClearSteps(\'' + feedbackId + '\', true)">Sí</button>' +
                    '<button class="feedback-yesno-btn" onclick="handleClearSteps(\'' + feedbackId + '\', false)">No</button>' +
                '</div>';
            
            container.appendChild(question);
            scrollToBottom();
        }
        
        // Create stars HTML
        function createStarsHTML(feedbackId, type) {
            var html = '';
            for (var i = 1; i <= 5; i++) {
                html += '<span class="feedback-star" data-rating="' + i + '" onclick="handleStarRating(\'' + feedbackId + '\', \'' + type + '\', ' + i + ')">☆</span>';
            }
            return html;
        }
        
        // Handle star rating
        function handleStarRating(feedbackId, type, rating) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var starsContainer = container.querySelector('.feedback-stars[data-type="' + type + '"]');
            if (!starsContainer) return;
            
            // Update visual state
            var stars = starsContainer.querySelectorAll('.feedback-star');
            stars.forEach(function(star, index) {
                if (index < rating) {
                    star.classList.add('active');
                    star.textContent = '★';
                } else {
                    star.classList.remove('active');
                    star.textContent = '☆';
                }
                star.style.pointerEvents = 'none';
            });
            
            // Save this rating
            var feedbackData = {};
            feedbackData[type + 'Rating'] = rating;
            saveFeedback(feedbackId, feedbackData);
            
            // Show next question
            setTimeout(function() {
                if (type === 'speed') {
                    showQualityQuestion(feedbackId);
                } else if (type === 'quality') {
                    showClearStepsQuestion(feedbackId);
                }
            }, 300);
        }
        
        // Handle clear steps response
        function handleClearSteps(feedbackId, clearSteps) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            var buttons = container.querySelectorAll('.feedback-yesno-btn');
            buttons.forEach(function(btn) {
                btn.disabled = true;
                btn.style.cursor = 'default';
            });
            buttons[clearSteps ? 0 : 1].classList.add('selected');
            
            // Save this response
            saveFeedback(feedbackId, { clearSteps: clearSteps });
            
            // Show thanks message
            setTimeout(function() {
                var thanks = document.createElement('div');
                thanks.className = 'feedback-thanks';
                thanks.textContent = '¡Gracias por tu valoración!';
                container.appendChild(thanks);
                scrollToBottom();
            }, 300);
        }
        
        // Show escalation panel
        function showEscalationPanel(feedbackId) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            // Get current conversation category
            var category = null;
            if (currentConversationId && localConversations[currentConversationId]) {
                category = localConversations[currentConversationId].category;
            }
            
            var panel = document.createElement('div');
            panel.className = 'escalation-panel';
            panel.id = feedbackId + '-escalation';
            
            var html = '<div class="escalation-title">Lamentamos que no se haya resuelto</div>';
            html += '<div class="escalation-subtitle">Puedes escalar tu consulta al equipo:</div>';
            
            // If no category, show selector
            if (!category || category === 'general') {
                html += '<div class="escalation-category-selector">' +
                    '<div class="escalation-category-label">Selecciona la categoría de tu consulta:</div>' +
                    '<div class="escalation-categories">' +
                        '<button class="escalation-category-btn" onclick="selectEscalationCategory(\'' + feedbackId + '\', \'comercial\')">Comercial</button>' +
                        '<button class="escalation-category-btn" onclick="selectEscalationCategory(\'' + feedbackId + '\', \'meta-ads\')">Meta Ads</button>' +
                        '<button class="escalation-category-btn" onclick="selectEscalationCategory(\'' + feedbackId + '\', \'gohighlevel\')">GoHighLevel</button>' +
                    '</div>' +
                '</div>';
                html += '<div class="escalation-content" style="display: none;"></div>';
            } else {
                html += getEscalationContentHTML(category);
            }
            
            html += '<button class="escalation-continue-btn" onclick="continueChat(\'' + feedbackId + '\')" style="margin-top: 1rem;">Continuar con el chat igualmente</button>';
            
            panel.innerHTML = html;
            container.appendChild(panel);
            
            // Block chat input and update category
            blockChat();
            updateConversationCategory('delegado');
            
            scrollToBottom();
        }
        
        // Select escalation category
        function selectEscalationCategory(feedbackId, category) {
            var panel = document.getElementById(feedbackId + '-escalation');
            if (!panel) return;
            
            // Update button states
            var buttons = panel.querySelectorAll('.escalation-category-btn');
            buttons.forEach(function(btn) {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Show escalation content
            var contentDiv = panel.querySelector('.escalation-content');
            if (contentDiv) {
                contentDiv.innerHTML = getEscalationContentHTML(category);
                contentDiv.style.display = 'block';
            }
            
            // Save selected category
            saveFeedback(feedbackId, { escalatedCategory: category });
            
            scrollToBottom();
        }
        
        // Get escalation content HTML
        function getEscalationContentHTML(category) {
            var resources = escalationResources[category];
            if (!resources) {
                resources = escalationResources['comercial']; // Default
            }
            
            return '<div class="escalation-loom">' +
                '<iframe src="' + resources.loom + '" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen style="width:100%; height:250px; border-radius:8px;"></iframe>' +
            '</div>' +
            '<a href="' + resources.doc + '" target="_blank" class="escalation-doc-link">' +
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                    '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>' +
                    '<polyline points="14 2 14 8 20 8"/>' +
                    '<line x1="16" y1="13" x2="8" y2="13"/>' +
                    '<line x1="16" y1="17" x2="8" y2="17"/>' +
                '</svg>' +
                'Abrir plantilla de solicitud' +
            '</a>';
        }
        
        // Block chat input
        function blockChat() {
            var inputArea = document.querySelector('.input-area');
            if (inputArea) {
                inputArea.classList.add('blocked');
            }
        }
        
        // Unblock chat input
        function unblockChat() {
            var inputArea = document.querySelector('.input-area');
            if (inputArea) {
                inputArea.classList.remove('blocked');
            }
        }
        
        // Continue chat after escalation
        function continueChat(feedbackId) {
            unblockChat();
            
            // Update feedback
            saveFeedback(feedbackId, { continuedAfterEscalation: true });
            
            // Focus on input
            document.getElementById('messageInput').focus();
        }
        
        // Update conversation category
        function updateConversationCategory(category) {
            if (!currentConversationId) return;
            
            // Update local state
            if (localConversations[currentConversationId]) {
                localConversations[currentConversationId].category = category;
            }
            
            // Update sidebar
            updateConversationInSidebar(currentConversationId, { category: category });
            
            // Update on server if real conversation
            if (!currentConversationId.startsWith('temp_') && window.API && window.API.updateConversationCategory) {
                window.API.updateConversationCategory(currentConversationId, category);
            }
        }
        
        // Save feedback to server
        function saveFeedback(feedbackId, data) {
            var container = document.getElementById(feedbackId);
            if (!container) return;
            
            // Build feedback object
            var feedback = {
                conversationId: currentConversationId,
                messageId: container.getAttribute('data-message-id') || null,
                timestamp: new Date().toISOString(),
                ...data
            };
            
            // Send to server
            if (window.API && window.API.saveFeedback) {
                window.API.saveFeedback(feedback).catch(function(err) {
                    console.error('Error saving feedback:', err);
                });
            }
            
            console.log('Feedback saved:', feedback);
        }
        
        // Scroll messages to bottom
        function scrollToBottom() {
            var messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                setTimeout(function() {
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 50);
            }
        }
        
        // Check if text contains a Loom embed
        function containsLoomEmbed(text) {
            return text && text.includes('loom.com/embed');
        }

        // ==================== END FEEDBACK SYSTEM ====================

        // Mobile menu
        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('mobileOverlay').classList.toggle('active');
        }
        function closeMobileMenu() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('mobileOverlay').classList.remove('active');
        }

        // Dropdown menu
        function toggleDropdown() {
            document.getElementById('dropdownMenu').classList.toggle('active');
        }
        function closeDropdown() {
            document.getElementById('dropdownMenu').classList.remove('active');
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-container')) {
                closeDropdown();
            }
        });

        // Dark mode
        if (localStorage.getItem('darkMode') === 'true') enableDarkMode();
        
        function toggleDarkMode() {
            darkMode ? disableDarkMode() : enableDarkMode();
        }
        function enableDarkMode() {
            document.body.classList.add('dark-mode');
            var toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.classList.add('active');
            darkMode = true;
            localStorage.setItem('darkMode', 'true');
        }
        function disableDarkMode() {
            document.body.classList.remove('dark-mode');
            var toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.classList.remove('active');
            darkMode = false;
            localStorage.setItem('darkMode', 'false');
        }

        // Auth
        function toggleAuthForm(e) {
            if (e) e.preventDefault();
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
            hideError('loginError');
            hideError('registerError');
        }

        function showSplashScreen() {
            document.getElementById('authContainer').style.display = 'none';
            var splash = document.getElementById('splashScreen');
            splash.classList.add('active');
            setTimeout(function() {
                splash.classList.remove('active');
                setTimeout(function() {
                    showApp();
                    loadConversations();
                }, 500);
            }, 2000);
        }

        function showApp() {
            document.getElementById('appContainer').classList.add('active');
        }

        function showError(elementId, message) {
            var el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
        }

        function hideError(elementId) {
            var el = document.getElementById(elementId);
            el.classList.remove('show');
            el.textContent = '';
        }

        // Get random welcome message
        function getRandomWelcome() {
            return welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
        }

        // Update welcome section
        function updateWelcomeSection() {
            var welcome = getRandomWelcome();
            document.getElementById('welcomeTitle').textContent = welcome.title;
            document.getElementById('welcomeSubtitle').textContent = welcome.subtitle;
        }

        // Generate temporary ID for new chats
        function generateTempId() {
            return 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Load conversations from API
        async function loadConversations() {
            if (!window.API) return;
            
            var result = await window.API.loadConversations();
            var container = document.getElementById('chatHistory');
            
            if (result.success && result.conversations && result.conversations.length > 0) {
                container.innerHTML = '';
                
                // Ordenar por updatedAt descendente (más reciente primero)
                var sortedConversations = result.conversations.sort(function(a, b) {
                    var dateA = new Date(a.updatedAt || 0);
                    var dateB = new Date(b.updatedAt || 0);
                    return dateB - dateA;
                });
                
                sortedConversations.forEach(function(conv) {
                    // Ordenar mensajes por fecha
                    var sortedMessages = (conv.messages || []).slice().sort(function(a, b) {
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                    localConversations[conv.id] = {
                        id: conv.id,
                        title: conv.title,
                        category: conv.category,
                        messages: sortedMessages,
                        hasMessages: true,
                        isNew: false
                    };
                    addConversationToSidebar(conv);
                });
            } else {
                container.innerHTML = '<div class="chat-history-empty">No hay conversaciones aún. ¡Inicia una nueva!</div>';
            }
        }

        // Add conversation to sidebar
        function addConversationToSidebar(conv, prepend) {
            var container = document.getElementById('chatHistory');
            
            var emptyMsg = container.querySelector('.chat-history-empty');
            if (emptyMsg) emptyMsg.remove();
            
            // Check if already exists
            var existing = container.querySelector('.chat-history-item[data-id="' + conv.id + '"]');
            if (existing) {
                existing.remove();
            }
            
            var lastMessage = conv.messages && conv.messages[0] ? conv.messages[0].content : 'Sin mensajes';
            var date = conv.updatedAt ? new Date(conv.updatedAt).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }) : 'Ahora';
            
            var div = document.createElement('div');
            div.className = 'chat-history-item' + (conv.isNew ? ' new-chat' : '');
            div.setAttribute('data-id', conv.id);
            div.onclick = function() { 
                openConversation(conv.id); 
            };
            div.innerHTML = 
                '<div class="chat-history-title">' + escapeHtml(conv.title) + '</div>' +
                '<div class="chat-history-preview">' + escapeHtml(lastMessage.substring(0, 50)) + '</div>' +
                '<div class="chat-history-meta">' +
                    '<span class="chat-history-date">' + date + '</span>' +
                    '<span class="chat-history-category">' + (conv.category || 'general') + '</span>' +
                '</div>';
            
            if (prepend) {
                container.insertBefore(div, container.firstChild);
            } else {
                container.appendChild(div);
            }
            
            return div;
        }

        // Update conversation in sidebar
        function updateConversationInSidebar(id, updates) {
            var item = document.querySelector('.chat-history-item[data-id="' + id + '"]');
            if (item) {
                if (updates.title) {
                    item.querySelector('.chat-history-title').textContent = updates.title;
                }
                if (updates.preview) {
                    item.querySelector('.chat-history-preview').textContent = updates.preview;
                }
                if (updates.category) {
                    var categoryEl = item.querySelector('.chat-history-category');
                    if (categoryEl) {
                        categoryEl.textContent = updates.category;
                    }
                }
                if (updates.newId) {
                    item.setAttribute('data-id', updates.newId);
                    item.classList.remove('new-chat');
                }
            }
        }

        // Move conversation to top of sidebar
        function moveConversationToTop(conversationId) {
            var container = document.getElementById('chatHistory');
            var item = container.querySelector('.chat-history-item[data-id="' + conversationId + '"]');
            if (item && container.firstChild !== item) {
                container.insertBefore(item, container.firstChild);
            }
        }

        // Open a conversation
        async function openConversation(conversationId) {
            if (window.innerWidth <= 768) closeMobileMenu();
            
            // Clear selected category when opening existing conversation
            selectedCategory = null;
            
            // Mark active in sidebar
            document.querySelectorAll('.chat-history-item').forEach(function(el) {
                el.classList.remove('active');
            });
            var activeItem = document.querySelector('.chat-history-item[data-id="' + conversationId + '"]');
            if (activeItem) activeItem.classList.add('active');
            
            // Check if it's a local/new conversation
            var localConv = localConversations[conversationId];
            
            if (localConv && localConv.isNew) {
                // It's a new local conversation
                currentConversationId = conversationId;
                currentConversationTitle = localConv.title;
                currentChatHasMessages = localConv.hasMessages;
                
                document.getElementById('welcomeSection').style.display = localConv.hasMessages ? 'none' : 'flex';
                var messagesArea = document.getElementById('messagesArea');
                
                if (localConv.hasMessages) {
                    messagesArea.classList.add('active');
                    messagesArea.innerHTML = '';
                    // Ordenar mensajes por fecha ascendente
                    var sortedMessages = localConv.messages.slice().sort(function(a, b) {
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                    sortedMessages.forEach(function(msg) {
                        var imageData = null;
                        if (msg.imageData && msg.imageMimeType) {
                            imageData = { data: msg.imageData, mimeType: msg.imageMimeType };
                        }
                        addMessageToUI(msg.content, msg.sender === 'user', msg.createdAt, imageData, false);
                    });
                } else {
                    messagesArea.classList.remove('active');
                    messagesArea.innerHTML = '';
                    updateWelcomeSection();
                }
                return;
            }
            
            // Load from API
            var result = await window.API.loadConversation(conversationId);
            
            if (result.success && result.conversation) {
                currentConversationId = conversationId;
                currentConversationTitle = result.conversation.title || 'Sin título';
                currentChatHasMessages = result.conversation.messages && result.conversation.messages.length > 0;
                window.API.setCurrentConversationId(conversationId);
                
                // Store locally (ordenados)
                var messagesOrdenados = (result.conversation.messages || []).slice().sort(function(a, b) {
                    return new Date(a.createdAt) - new Date(b.createdAt);
                });
                localConversations[conversationId] = {
                    id: conversationId,
                    title: result.conversation.title,
                    category: result.conversation.category,
                    messages: messagesOrdenados,
                    hasMessages: currentChatHasMessages,
                    isNew: false
                };
                
                // Show messages area
                document.getElementById('welcomeSection').style.display = 'none';
                var messagesArea = document.getElementById('messagesArea');
                messagesArea.classList.add('active');
                messagesArea.innerHTML = '';
                
                if (result.conversation.messages) {
                    // Ordenar mensajes por fecha ascendente
                    var sortedMessages = result.conversation.messages.slice().sort(function(a, b) {
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });
                    sortedMessages.forEach(function(msg) {
                        var imageData = null;
                        if (msg.imageData && msg.imageMimeType) {
                            imageData = { data: msg.imageData, mimeType: msg.imageMimeType };
                        }
                        addMessageToUI(msg.content, msg.sender === 'user', msg.createdAt, imageData, false);
                    });
                }
            }
        }

        // Add message to UI - Nuevo diseño sin avatares ni burbujas para bot
        // Typewriter effect - muestra texto palabra por palabra
        function typeWriter(element, text, speed = 30) {
            var words = text.split(' ');
            var currentIndex = 0;
            var currentText = '';
            
            function addWord() {
                if (currentIndex < words.length) {
                    currentText += (currentIndex > 0 ? ' ' : '') + words[currentIndex];
                    element.innerHTML = currentText;
                    currentIndex++;
                    
                    // Scroll mientras se escribe
                    var messagesArea = document.getElementById('messagesArea');
                    messagesArea.scrollTop = messagesArea.scrollHeight;
                    
                    setTimeout(addWord, speed);
                }
            }
            
            addWord();
        }

        function addMessageToUI(text, isUser, timestamp, imageData, animate = true, messageId = null) {
            var messagesArea = document.getElementById('messagesArea');
            var div = document.createElement('div');
            
            // Generate message ID if not provided
            var msgId = messageId || ('msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
            div.setAttribute('data-message-id', msgId);
            
            div.className = 'message ' + (isUser ? 'user' : 'bot');
            
            var time;
            if (timestamp) {
                time = new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else {
                time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
            
            var imageHtml = '';
            if (imageData && imageData.data && imageData.mimeType) {
                imageHtml = '<img src="data:' + imageData.mimeType + ';base64,' + imageData.data + '" alt="Imagen adjunta" class="message-image">';
            } else if (text && text.includes('[Imagen adjunta]')) {
                imageHtml = '<div class="message-image-indicator">Imagen adjunta</div>';
                text = text.replace('[Imagen adjunta]', '').trim();
            }
            
            // Check if message contains Loom embed
            var hasLoom = containsLoomEmbed(text);
            
            // Crear estructura del mensaje
            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (imageHtml) {
                contentDiv.innerHTML = imageHtml;
            }
            
            var textDiv = null;
            if (text) {
                textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                contentDiv.appendChild(textDiv);
            }
            
            var timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = time;
            contentDiv.appendChild(timeDiv);
            
            div.appendChild(contentDiv);
            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // Aplicar efecto typewriter o mostrar directamente
            if (text && textDiv) {
                if (!isUser && animate && !hasLoom) {
                    // Efecto typewriter para respuestas del bot sin Loom
                    typeWriter(textDiv, text, 25);
                } else {
                    // Sin animación - mostrar todo de golpe (necesario para iframes)
                    textDiv.innerHTML = text;
                    
                    // Si tiene Loom y es mensaje del bot, añadir feedback
                    if (hasLoom && !isUser) {
                        setTimeout(function() {
                            var feedbackComponent = createFeedbackComponent(msgId);
                            div.appendChild(feedbackComponent);
                            scrollToBottom();
                        }, 500);
                    }
                }
            }
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');

            if (window.API && window.API.isAuthenticated()) {
                currentUser = window.API.getCurrentUser();
                if (currentUser) {
                    userIsAdmin = currentUser.role === 'admin';
                    document.getElementById('authContainer').style.display = 'none';
                    showApp();
                    loadConversations();
                    if (userIsAdmin) document.getElementById('adminSection').style.display = 'block';
                }
            }

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideError('loginError');
                
                var email = document.getElementById('loginEmail').value.trim();
                var password = document.getElementById('loginPassword').value;
                var btn = document.getElementById('loginBtn');
                
                if (!email) {
                    showError('loginError', 'Por favor, introduce tu correo electrónico');
                    return;
                }
                
                if (!password) {
                    showError('loginError', 'Por favor, introduce tu contraseña');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Iniciando sesión...';

                try {
                    if (window.API && window.API.login) {
                        var result = await window.API.login(email, password);
                        
                        if (result.success) {
                            currentUser = result.user;
                            userIsAdmin = currentUser && currentUser.role === 'admin';
                            if (userIsAdmin) document.getElementById('adminSection').style.display = 'block';
                            showSplashScreen();
                        } else {
                            showError('loginError', translateError(result.error));
                        }
                    } else {
                        showError('loginError', 'El servicio no está disponible en este momento');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    showError('loginError', 'Error de conexión. Comprueba tu conexión a internet');
                }

                btn.disabled = false;
                btn.textContent = 'Iniciar Sesión';
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                hideError('registerError');
                
                var name = document.getElementById('registerName').value.trim();
                var email = document.getElementById('registerEmail').value.trim();
                var phone = document.getElementById('registerPhone').value.trim();
                var company = document.getElementById('registerCompany').value.trim();
                var password = document.getElementById('registerPassword').value;
                var btn = document.getElementById('registerBtn');

                if (!name) {
                    showError('registerError', 'Por favor, introduce tu nombre');
                    return;
                }
                
                if (!email) {
                    showError('registerError', 'Por favor, introduce tu correo electrónico');
                    return;
                }
                
                if (!password) {
                    showError('registerError', 'Por favor, introduce una contraseña');
                    return;
                }

                if (password.length < 6) {
                    showError('registerError', 'La contraseña debe tener al menos 6 caracteres');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Creando cuenta...';

                try {
                    if (window.API && window.API.register) {
                        var userData = {
                            name: name,
                            email: email,
                            password: password,
                            phone: phone || '',
                            company: company || ''
                        };
                        
                        var result = await window.API.register(userData);
                        
                        if (result.success) {
                            currentUser = result.user;
                            userIsAdmin = false;
                            showSplashScreen();
                        } else {
                            showError('registerError', translateError(result.error));
                        }
                    } else {
                        showError('registerError', 'El servicio no está disponible en este momento');
                    }
                } catch (err) {
                    console.error('Register error:', err);
                    showError('registerError', 'Error de conexión. Comprueba tu conexión a internet');
                }

                btn.disabled = false;
                btn.textContent = 'Crear Cuenta';
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSettings();
                    closeRenameModal();
                    closeDeleteModal();
                    closeDropdown();
                }
            });

            console.log('App ready!');
        });

        // Chat functions
        function startNewChat() {
            if (window.innerWidth <= 768) closeMobileMenu();
            
            // Clear selected category
            selectedCategory = null;
            
            // Check if current chat has no messages - prevent creating another empty chat
            if (currentConversationId && localConversations[currentConversationId]) {
                var currentConv = localConversations[currentConversationId];
                if (currentConv.isNew && !currentConv.hasMessages) {
                    // Current chat is empty, just focus on it
                    document.getElementById('messageInput').focus();
                    return;
                }
            }
            
            // Create new local conversation
            var tempId = generateTempId();
            var newConv = {
                id: tempId,
                title: 'Nueva Conversación',
                category: 'general',
                messages: [],
                hasMessages: false,
                isNew: true
            };
            
            localConversations[tempId] = newConv;
            currentConversationId = tempId;
            currentConversationTitle = 'Nueva Conversación';
            currentChatHasMessages = false;
            
            // Remove active from all items
            document.querySelectorAll('.chat-history-item').forEach(function(el) {
                el.classList.remove('active');
            });
            
            // Add to sidebar
            var item = addConversationToSidebar({
                id: tempId,
                title: 'Nueva Conversación',
                messages: [{ content: 'Escribe tu primer mensaje...' }],
                category: 'general',
                isNew: true
            }, true);
            item.classList.add('active');
            
            // Show welcome section with categories
            updateWelcomeSection();
            document.getElementById('welcomeSection').style.display = 'flex';
            document.getElementById('messagesArea').classList.remove('active');
            document.getElementById('messagesArea').innerHTML = '';
            
            document.getElementById('messageInput').focus();
        }

        function selectCategory(category) {
            if (window.innerWidth <= 768) closeMobileMenu();
            
            // Save selected category globally
            selectedCategory = category;
            
            // Mark selected card
            var cards = document.querySelectorAll('.category-card');
            cards.forEach(function(card) {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            var welcomeSection = document.getElementById('welcomeSection');
            var messagesArea = document.getElementById('messagesArea');
            
            // Animate slide up
            welcomeSection.classList.add('slide-up');
            
            setTimeout(function() {
                welcomeSection.style.display = 'none';
                welcomeSection.classList.remove('slide-up');
                
                // Reset selected state
                cards.forEach(function(card) {
                    card.classList.remove('selected');
                });
                
                messagesArea.classList.add('active');
                messagesArea.classList.add('slide-up-in');
                messagesArea.innerHTML = '';
                
                var categoryMessages = {
                    'comercial': '¡Hola! Soy tu asistente comercial. ¿En qué puedo ayudarte con ventas o captación de propiedades?',
                    'meta-ads': '¡Hola! Soy tu experto en Meta Ads. ¿Tienes dudas sobre campañas publicitarias?',
                    'gohighlevel': '¡Hola! Estoy aquí para ayudarte con GoHighLevel. ¿Qué necesitas configurar o automatizar?'
                };
                
                addMessageToUI(categoryMessages[category] || '¿En qué puedo ayudarte?', false, null, null, true);
                
                // Update local conversation category and sidebar if exists
                if (currentConversationId && localConversations[currentConversationId]) {
                    localConversations[currentConversationId].category = category;
                    updateConversationInSidebar(currentConversationId, { category: category });
                }
                
                document.getElementById('messageInput').focus();
                
                // Remove animation class after it completes
                setTimeout(function() {
                    messagesArea.classList.remove('slide-up-in');
                }, 400);
            }, 350);
        }

        async function sendMessage() {
            if (isSending) return;
            
            var input = document.getElementById('messageInput');
            var message = input.value.trim();
            
            // Allow sending if there's a message OR an image
            if (!message && !selectedImageBase64) return;
            
            // Capturar el ID de la conversación ANTES de cualquier operación async
            var sendingToConversationId = currentConversationId;
            
            isSending = true;
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('attachBtn').disabled = true;
            
            // Hide welcome if visible
            if (document.getElementById('welcomeSection').style.display !== 'none') {
                document.getElementById('welcomeSection').style.display = 'none';
                document.getElementById('messagesArea').classList.add('active');
            }
            
            // Capture image data before clearing
            var imageToSend = selectedImageBase64 ? {
                data: selectedImageBase64,
                mimeType: selectedImageMimeType
            } : null;
            
            // Show user message with image
            var displayMessage = message || (imageToSend ? '' : '');
            addMessageToUI(displayMessage, true, null, imageToSend, true);
            input.value = '';
            
            // Clear image after capturing
            var imageBase64ToSend = selectedImageBase64;
            var imageMimeTypeToSend = selectedImageMimeType;
            removeSelectedImage();
            
            // Update local state
            currentChatHasMessages = true;
            if (sendingToConversationId && localConversations[sendingToConversationId]) {
                localConversations[sendingToConversationId].hasMessages = true;
                localConversations[sendingToConversationId].messages.push({
                    content: imageBase64ToSend ? '[Imagen adjunta] ' + message : message,
                    sender: 'user',
                    createdAt: new Date().toISOString()
                });
            }
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // For new conversations, don't send the temp ID to the API
                var apiConversationId = null;
                if (sendingToConversationId && !sendingToConversationId.startsWith('temp_')) {
                    apiConversationId = sendingToConversationId;
                }
                
                // Get category from local conversation or from selectedCategory
                var categoryToSend = null;
                if (sendingToConversationId && localConversations[sendingToConversationId]) {
                    categoryToSend = localConversations[sendingToConversationId].category;
                }
                // Fallback to selectedCategory if no conversation exists
                if (!categoryToSend && selectedCategory) {
                    categoryToSend = selectedCategory;
                }
                
                var result = await window.API.sendMessage(message, apiConversationId, imageBase64ToSend, imageMimeTypeToSend, categoryToSend);
                
                hideTypingIndicator();
                
                // Verificar si seguimos en la misma conversación
                var stillInSameChat = (currentConversationId === sendingToConversationId);
                
                if (result.success) {
                    // Update conversation with real ID if it was new (null or temp_)
                    if (result.conversation && (!sendingToConversationId || sendingToConversationId.startsWith('temp_'))) {
                        var oldId = sendingToConversationId; // puede ser null o temp_xxx
                        var newId = result.conversation.id;
                        var newTitle = result.conversation.title || message.substring(0, 50);
                        var convCategory = categoryToSend || result.conversation.category || (oldId && localConversations[oldId] ? localConversations[oldId].category : null) || 'general';
                        
                        // IMPORTANTE: Verificar si el usuario sigue en el chat original ANTES de hacer cambios
                        var userStillInOriginalChat = (currentConversationId === oldId);
                        
                        // Migrar datos locales (esto siempre se hace)
                        if (oldId && localConversations[oldId]) {
                            localConversations[newId] = localConversations[oldId];
                            delete localConversations[oldId];
                        } else {
                            // Era null, crear nuevo registro
                            localConversations[newId] = {
                                id: newId,
                                title: newTitle,
                                category: convCategory,
                                messages: [{
                                    content: imageBase64ToSend ? '[Imagen adjunta] ' + message : message,
                                    sender: 'user',
                                    createdAt: new Date().toISOString()
                                }],
                                hasMessages: true,
                                isNew: false
                            };
                        }
                        
                        localConversations[newId].id = newId;
                        localConversations[newId].title = newTitle;
                        localConversations[newId].category = convCategory;
                        localConversations[newId].isNew = false;
                        
                        // Actualizar sendingToConversationId para guardar el mensaje del bot correctamente
                        sendingToConversationId = newId;
                        
                        // Actualizar sidebar (siempre, independientemente de dónde esté el usuario)
                        if (oldId) {
                            updateConversationInSidebar(oldId, {
                                newId: newId,
                                title: newTitle,
                                preview: message.substring(0, 50),
                                category: convCategory
                            });
                        } else {
                            // Era null, añadir nuevo al sidebar
                            addConversationToSidebar({
                                id: newId,
                                title: newTitle,
                                messages: [{ content: message }],
                                category: convCategory,
                                updatedAt: new Date().toISOString()
                            }, true);
                        }
                        
                        // Actualizar onclick handler (siempre)
                        var item = document.querySelector('.chat-history-item[data-id="' + newId + '"]');
                        if (item) {
                            item.onclick = function() { openConversation(newId); };
                        }
                        
                        // SOLO si el usuario sigue en el chat original, actualizar estado de UI
                        if (userStillInOriginalChat) {
                            currentConversationId = newId;
                            currentConversationTitle = newTitle;
                            window.API.setCurrentConversationId(newId);
                            
                            // Marcar como activo en sidebar
                            document.querySelectorAll('.chat-history-item').forEach(function(el) {
                                el.classList.remove('active');
                            });
                            if (item) item.classList.add('active');
                            
                            stillInSameChat = true;
                        }
                        // Si el usuario cambió de chat, stillInSameChat permanece false (ya calculado arriba)
                        
                        // Clear selectedCategory since conversation is now created
                        selectedCategory = null;
                    }
                    
                    // Store bot message locally (siempre)
                    if (result.botMessage && localConversations[sendingToConversationId]) {
                        localConversations[sendingToConversationId].messages.push({
                            content: result.botMessage.content,
                            sender: 'bot',
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    // Show bot response solo si seguimos en el mismo chat
                    if (result.botMessage && stillInSameChat) {
                        addMessageToUI(result.botMessage.content, false, null, null, true);
                    }
                    
                    // Mover conversación al inicio del sidebar
                    moveConversationToTop(sendingToConversationId);
                } else {
                    if (stillInSameChat) {
                        addMessageToUI('Lo siento, hubo un error. Por favor intenta de nuevo.', false, null, null, true);
                    }
                }
            } catch (err) {
                hideTypingIndicator();
                console.error('Send error:', err);
                if (currentConversationId === sendingToConversationId) {
                    addMessageToUI('Error de conexión. Por favor intenta de nuevo.', false, null, null, true);
                }
            }
            
            isSending = false;
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('attachBtn').disabled = false;
            input.focus();
        }

        function showTypingIndicator() {
            var messagesArea = document.getElementById('messagesArea');
            var div = document.createElement('div');
            div.className = 'message bot';
            div.id = 'typingIndicator';
            div.innerHTML = '<div class="message-content"><div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>';
            messagesArea.appendChild(div);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function hideTypingIndicator() {
            var el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Image handling functions
        function handleImageSelect(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona una imagen válida');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('La imagen es demasiado grande. Máximo 5MB.');
                return;
            }
            
            selectedImageMimeType = file.type;
            selectedImageName = file.name;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var base64 = e.target.result.split(',')[1];
                selectedImageBase64 = base64;
                
                // Show preview
                document.getElementById('imagePreviewImg').src = e.target.result;
                document.getElementById('imagePreviewName').textContent = file.name;
                document.getElementById('imagePreviewSize').textContent = formatFileSize(file.size);
                document.getElementById('imagePreviewContainer').classList.add('active');
                document.getElementById('attachBtn').classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        function removeSelectedImage() {
            selectedImageBase64 = null;
            selectedImageMimeType = null;
            selectedImageName = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreviewContainer').classList.remove('active');
            document.getElementById('attachBtn').classList.remove('has-image');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Rename conversation
        function openRenameModal() {
            closeDropdown();
            if (!currentConversationId) {
                alert('Selecciona una conversación primero');
                return;
            }
            document.getElementById('renameInput').value = currentConversationTitle;
            document.getElementById('renameModal').classList.add('active');
            document.getElementById('renameInput').focus();
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
        }

        async function renameConversation() {
            var newTitle = document.getElementById('renameInput').value.trim();
            if (!newTitle) {
                alert('El nombre no puede estar vacío');
                return;
            }

            // Update local first
            currentConversationTitle = newTitle;
            if (localConversations[currentConversationId]) {
                localConversations[currentConversationId].title = newTitle;
            }
            updateConversationInSidebar(currentConversationId, { title: newTitle });

            // If it's a real conversation, update on server
            if (currentConversationId && !currentConversationId.startsWith('temp_')) {
                var result = await window.API.renameConversation(currentConversationId, newTitle);
                if (!result.success) {
                    console.error('Error renaming on server:', result.error);
                }
            }
            
            closeRenameModal();
        }

        // Delete conversation
        function confirmDeleteConversation() {
            closeDropdown();
            if (!currentConversationId) {
                alert('Selecciona una conversación primero');
                return;
            }
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function deleteConversation() {
            if (!currentConversationId) {
                closeDeleteModal();
                return;
            }

            var idToDelete = currentConversationId;
            var isTemp = idToDelete.startsWith('temp_');

            // Remove from local storage
            delete localConversations[idToDelete];
            
            // Remove from sidebar
            var item = document.querySelector('.chat-history-item[data-id="' + idToDelete + '"]');
            if (item) item.remove();
            
            // Reset view
            currentConversationId = null;
            currentConversationTitle = '';
            currentChatHasMessages = false;
            document.getElementById('welcomeSection').style.display = 'flex';
            document.getElementById('messagesArea').classList.remove('active');
            updateWelcomeSection();

            // If it's a real conversation, delete on server
            if (!isTemp) {
                var result = await window.API.deleteConversation(idToDelete);
                if (!result.success) {
                    console.error('Error deleting on server:', result.error);
                }
            }
            
            closeDeleteModal();
        }

        // Settings
        function openSettings() {
            var user = window.API ? window.API.getCurrentUser() : currentUser;
            if (user) {
                document.getElementById('settingsName').value = user.name || '';
                document.getElementById('settingsEmail').value = user.email || '';
                document.getElementById('settingsPhone').value = user.phone || '';
                document.getElementById('settingsCompany').value = user.company || '';
            }
            
            // Set notification toggle state
            var notificationsEnabled = localStorage.getItem('notifications') !== 'false';
            var notifToggle = document.getElementById('notificationsToggle');
            if (notifToggle) {
                if (notificationsEnabled) {
                    notifToggle.classList.add('active');
                } else {
                    notifToggle.classList.remove('active');
                }
            }
            
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleNotifications() {
            var toggle = document.getElementById('notificationsToggle');
            var isEnabled = toggle.classList.contains('active');
            
            if (isEnabled) {
                toggle.classList.remove('active');
                localStorage.setItem('notifications', 'false');
            } else {
                toggle.classList.add('active');
                localStorage.setItem('notifications', 'true');
            }
        }

        async function saveProfile() {
            var name = document.getElementById('settingsName').value.trim();
            var phone = document.getElementById('settingsPhone').value.trim();
            var company = document.getElementById('settingsCompany').value.trim();
            
            if (!name) {
                alert('El nombre no puede estar vacío');
                return;
            }
            
            try {
                if (window.API && window.API.updateProfile) {
                    var result = await window.API.updateProfile({ name, phone, company });
                    if (result.success) {
                        currentUser = result.user || { ...currentUser, name, phone, company };
                        alert('Perfil actualizado correctamente');
                    } else {
                        alert(translateError(result.error));
                    }
                } else {
                    // Fallback: guardar localmente
                    if (currentUser) {
                        currentUser.name = name;
                        currentUser.phone = phone;
                        currentUser.company = company;
                    }
                    alert('Perfil actualizado correctamente');
                }
            } catch (err) {
                console.error('Error saving profile:', err);
                alert('Error de conexión. Comprueba tu conexión a internet');
            }
        }

        function openChangePasswordModal() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            hideError('passwordError');
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        async function changePassword() {
            var currentPwd = document.getElementById('currentPassword').value;
            var newPwd = document.getElementById('newPassword').value;
            var confirmPwd = document.getElementById('confirmPassword').value;
            
            hideError('passwordError');
            
            if (!currentPwd) {
                showError('passwordError', 'Por favor, introduce tu contraseña actual');
                return;
            }
            
            if (!newPwd) {
                showError('passwordError', 'Por favor, introduce la nueva contraseña');
                return;
            }
            
            if (newPwd.length < 6) {
                showError('passwordError', 'La nueva contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showError('passwordError', 'Las contraseñas no coinciden');
                return;
            }
            
            try {
                if (window.API && window.API.changePassword) {
                    var result = await window.API.changePassword(currentPwd, newPwd);
                    if (result.success) {
                        alert('Contraseña cambiada correctamente');
                        closeChangePasswordModal();
                    } else {
                        showError('passwordError', translateError(result.error));
                    }
                } else {
                    showError('passwordError', 'El servicio no está disponible en este momento');
                }
            } catch (err) {
                console.error('Error changing password:', err);
                showError('passwordError', 'Error de conexión. Comprueba tu conexión a internet');
            }
        }

        function logout() {
            if (window.API) window.API.logout();
            currentUser = null;
            userIsAdmin = false;
            currentConversationId = null;
            currentChatHasMessages = false;
            selectedCategory = null;
            localConversations = {};
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            closeSettings();
        }

        // CORREGIDO: Redirigir al panel de admin
        function goToAdmin() {
            if (userIsAdmin) {
                window.location.href = '/admin.html';
            }
        }
    </script>
</body>
</html>
